# SPDX-FileCopyrightText: 2024 UL Research Institutes
# SPDX-License-Identifier: Apache-2.0

stages:
  - test
  - build
  - deploy

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_OPEN_MERGE_REQUESTS
      when: never
    - when: always

variables:
  PYTHON_PACKAGE: lens_focal

include:
  - project: buildgarden/pipelines/detect-secrets
    ref: 0.2.1
    file:
      - detect-secrets.yml
  - project: buildgarden/pipelines/gitlab
    ref: 0.2.2
    file:
      - gitlab-release.yml
  - project: buildgarden/pipelines/prettier
    ref: 0.3.2
    file:
      - prettier.yml
  - project: buildgarden/pipelines/python
    ref: 0.14.0
    file:
      - python-autoflake.yml
      - python-black.yml
      - python-build-sdist.yml
      - python-build-wheel.yml
      - python-isort.yml
      - python-pyroma.yml
      - python-twine-upload.yml
      - python-vulture.yml
  - project: buildgarden/pipelines/skywalking-eyes
    ref: 0.2.2
    file: license-eye-header-check.yml
python-twine-upload-pypi-oidc:
  stage: deploy
  image: ${CONTAINER_PROXY}python:3.11-alpine
  variables:
    GIT_DEPTH: '1'
    GIT_SUBMODULE_STRATEGY: none
  id_tokens:
    PYPI_ID_TOKEN:
      aud: pypi
  script:
    - apk add --no-cache curl jq
    - python3 -m pip install uv
    - uv pip install --system twine id
    - OIDC_TOKEN="$(python3 -m id PYPI)"
    - RESP="$(curl -X POST https://pypi.org/_/oidc/mint-token -d "{\"token\":\"${OIDC_TOKEN}\"}")"
    - API_TOKEN="$(echo "$RESP" | jq --raw-output '.token')"
    - python3 -m twine upload -u __token__ -p "$API_TOKEN" dist/*
  rules:
    - if: $CI_COMMIT_TAG
