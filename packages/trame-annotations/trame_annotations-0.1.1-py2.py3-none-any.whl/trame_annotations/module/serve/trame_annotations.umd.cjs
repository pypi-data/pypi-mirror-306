(function(x,o){typeof exports=="object"&&typeof module<"u"?o(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],o):(x=typeof globalThis<"u"?globalThis:x||self,o(x.trame_annotations={},x.Vue))})(this,function(x,o){"use strict";class C{constructor(e,n=0){this.bounds={x:e.x||0,y:e.y||0,width:e.width,height:e.height},this.maxObjects=typeof e.maxObjects=="number"?e.maxObjects:10,this.maxLevels=typeof e.maxLevels=="number"?e.maxLevels:4,this.level=n,this.objects=[],this.nodes=[]}getIndex(e){return e.qtIndex(this.bounds)}split(){const e=this.level+1,n=this.bounds.width/2,t=this.bounds.height/2,s=this.bounds.x,f=this.bounds.y,c=[{x:s+n,y:f},{x:s,y:f},{x:s,y:f+t},{x:s+n,y:f+t}];for(let a=0;a<4;a++)this.nodes[a]=new C({x:c[a].x,y:c[a].y,width:n,height:t,maxObjects:this.maxObjects,maxLevels:this.maxLevels},e)}insert(e){if(this.nodes.length){const n=this.getIndex(e);for(let t=0;t<n.length;t++)this.nodes[n[t]].insert(e);return}if(this.objects.push(e),this.objects.length>this.maxObjects&&this.level<this.maxLevels){this.nodes.length||this.split();for(let n=0;n<this.objects.length;n++){const t=this.getIndex(this.objects[n]);for(let s=0;s<t.length;s++)this.nodes[t[s]].insert(this.objects[n])}this.objects=[]}}retrieve(e){const n=this.getIndex(e);let t=this.objects;if(this.nodes.length)for(let s=0;s<n.length;s++)t=t.concat(this.nodes[n[s]].retrieve(e));return this.level===0?Array.from(new Set(t)):t}remove(e,n=!1){const t=this.objects.indexOf(e);t>-1&&this.objects.splice(t,1);for(let s=0;s<this.nodes.length;s++)this.nodes[s].remove(e);return this.level===0&&!n&&this.join(),t!==-1}update(e,n=!1){this.remove(e,n),this.insert(e)}join(){let e=Array.from(this.objects);for(let t=0;t<this.nodes.length;t++){const s=this.nodes[t].join();e=e.concat(s)}const n=Array.from(new Set(e));if(n.length<=this.maxObjects){this.objects=n;for(let t=0;t<this.nodes.length;t++)this.nodes[t].objects=[];this.nodes=[]}return e}clear(){this.objects=[];for(let e=0;e<this.nodes.length;e++)this.nodes.length&&this.nodes[e].clear();this.nodes=[]}}class L{constructor(e){this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this.data=e.data}qtIndex(e){const n=[],t=e.x+e.width/2,s=e.y+e.height/2,f=this.y<s,c=this.x<t,a=this.x+this.width>t,m=this.y+this.height>s;return f&&a&&n.push(0),c&&f&&n.push(1),c&&m&&n.push(2),a&&m&&n.push(3),n}}function H(d){return o.getCurrentScope()?(o.onScopeDispose(d),!0):!1}function B(){const d=o.ref(1);if(window){let e=function(){d.value=window.devicePixelRatio,n(),t=window.matchMedia(`(resolution: ${d.value}dppx)`),t.addEventListener("change",e,{once:!0})},n=function(){t==null||t.removeEventListener("change",e)},t;e(),H(n)}return{pixelRatio:d}}const F={style:{position:"relative"}},G=["src"],A=.9,J=4,k=12,K={ImageDetection:o.defineComponent({__name:"ImageDetection",props:{identifier:{},src:{},annotations:{},categories:{},selected:{type:Boolean},containerSelector:{}},emits:["hover"],setup(d,{emit:e}){const n=[[255,0,0],[0,255,0],[0,0,255],[255,255,0],[255,0,255],[0,255,255]],t=[8,8];let s;function f(i,l){return l.x>=i.x+i.width||i.x>=l.x+l.width?!1:!(l.y>=i.y+i.height||i.y>=l.y+l.height)}const c=d,a=o.ref(),m=o.computed(()=>{var i;return(i=a.value)==null?void 0:i.getContext("2d",{alpha:!0})}),g=o.ref(),I=o.computed(()=>{var i;return(i=g.value)==null?void 0:i.getContext("2d",{willReadFrequently:!0})}),u=o.ref(),p=o.ref({width:0,height:0}),_=o.ref(),U=()=>{var i,l;p.value={width:((i=_.value)==null?void 0:i.naturalWidth)??0,height:((l=_.value)==null?void 0:l.naturalHeight)??0}},T=o.computed(()=>o.unref(c.annotations)??[]),D=o.computed(()=>T.value.map(i=>{const l=i.category_id??0,h=n[l%n.length];return{...i,color:h}})),Z=B(),ee=o.computed(()=>J*Z.pixelRatio.value);o.watchEffect(()=>{if(!a.value||!m.value)return;const i=a.value,l=m.value;i.width=p.value.width,i.height=p.value.height,l.clearRect(0,0,i.width,i.height),l.lineWidth=ee.value,D.value.forEach(({color:h,bbox:r})=>{l.strokeStyle=`rgba(${[...h,A].join(",")})`,l.strokeRect(r[0],r[1],r[2],r[3])})}),o.watchEffect(()=>{if(!I.value||!g.value)return;const i=g.value,l=I.value;i.width=p.value.width,i.height=p.value.height,l.clearRect(0,0,i.width,i.height),s=new C({width:i.width,height:i.height,maxLevels:8,maxObjects:10}),T.value.forEach((h,r)=>{const y=new L({x:h.bbox[0],y:h.bbox[1],width:h.bbox[2],height:h.bbox[3],data:r});s==null||s.insert(y),l.fillStyle="rgb(255, 0, 0)",l.fillRect(h.bbox[0],h.bbox[1],h.bbox[2],h.bbox[3])})});const N=e;function V(){u.value&&(u.value.style.visibility="hidden")}o.onMounted(V);function te(){N("hover",{id:c.identifier})}function ie(){N("hover",{id:""}),V()}function ne(i,l,h){const r=h.getBoundingClientRect(),y=h.width*(i-r.left)/r.width,P=h.height*(l-r.top)/r.height;return[y,P]}const M=o.ref(!1);o.onMounted(()=>{M.value=!0});const oe=o.computed(()=>!M.value||!c.containerSelector?null:document.querySelector(c.containerSelector));function se(i){var X;if(!g.value||g.value.width===0||!u.value||!s||!c.categories||!c.annotations)return;const l=I.value;if(!l)return;const[h,r]=ne(i.clientX,i.clientY,g.value);if(!(l.getImageData(h,r,1,1).data[0]>0)){u.value.style.visibility="hidden";return}u.value.style.visibility="visible";const W=new L({x:h,y:r,width:2,height:2}),ce=s.retrieve(W).filter(v=>f(v,W)).filter(v=>v.data!=null).map(v=>{var z;const b=D.value[v.data],re=((z=c.categories[b.category_id])==null?void 0:z.name)??b.label,ae=b.color,E=document.createElement("li");E.style.textShadow=`rgba(${ae.join(",")},0.6) 1px 1px 3px`;const de=b.id?` : ${b.id}`:"";return E.textContent=`${re}${de}`,E});u.value.replaceChildren(...ce);const[Y,$]=[i.offsetX,i.offsetY];let S=Y+t[0],R=$+t[1];const w=u.value.getBoundingClientRect(),q=g.value.getBoundingClientRect(),O=((X=oe.value)==null?void 0:X.getBoundingClientRect())??{left:0,top:0,width:window.innerWidth,height:window.innerHeight},j={left:q.left+S-O.left,top:q.top+R-O.top,width:w.width+k,height:w.height+k};j.left+j.width>O.width&&(S=Y-w.width-t[0]),j.top+j.height>O.height&&(R=$-w.height-t[1]),u.value.style.left=`${S}px`,u.value.style.top=`${R}px`}const le=o.computed(()=>c.selected?"4":"0"),he=o.computed(()=>o.unref(c.src));return(i,l)=>(o.openBlock(),o.createElementBlock("div",F,[o.createElementVNode("img",{ref_key:"img",ref:_,src:he.value,style:o.normalizeStyle([{outlineWidth:le.value+"px"},{width:"100%","outline-style":"dotted","outline-color":"red"}]),onLoad:U},null,44,G),o.createElementVNode("canvas",{ref_key:"visibleCanvas",ref:a,style:{width:"100%",position:"absolute",left:"0",top:"0"}},null,512),o.createElementVNode("canvas",{ref_key:"pickingCanvas",ref:g,style:{opacity:"0",width:"100%",position:"absolute",left:"0",top:"0"},onMouseenter:te,onMousemove:se,onMouseleave:ie},null,544),o.createElementVNode("ul",{ref_key:"labelContainer",ref:u,style:{position:"absolute","z-index":"10",padding:"0.4rem","white-space":"pre","font-size":"small","border-radius":"0.2rem","border-color":"rgba(127, 127, 127, 0.75)","border-style":"solid","border-width":"thin","background-color":"#efefef","list-style-type":"none"}},null,512)]))}})};function Q(d){Object.entries(K).forEach(([e,n])=>{d.component(e,n)})}x.install=Q,Object.defineProperty(x,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=trame_annotations.umd.cjs.map
