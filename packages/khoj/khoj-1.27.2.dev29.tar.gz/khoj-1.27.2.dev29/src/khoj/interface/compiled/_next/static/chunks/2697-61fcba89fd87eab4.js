(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2697],{82697:function(e,t,n){"use strict";n.d(t,{Z:function(){return x}});var s=n(57437),o=n(15238),a=n.n(o),i=n(2265),l=n(53423),r=n(94880),c=n(58485),u=n(16288),d=n(20721),g=n(26100),h=n(19666),m=n(50495),v=e=>{let{name:t,avatar:n,link:o,description:a}=e;return(0,s.jsx)("div",{className:"relative group flex",children:(0,s.jsx)(h.pn,{children:(0,s.jsxs)(h.u,{delayDuration:0,children:[(0,s.jsx)(h.aJ,{asChild:!0,children:(0,s.jsxs)(m.z,{variant:"ghost",className:"flex items-center justify-center",children:[n,(0,s.jsx)("div",{children:t})]})}),(0,s.jsx)(h._v,{children:(0,s.jsxs)("div",{className:"w-80 h-30",children:[(0,s.jsx)("a",{href:o,target:"_blank",rel:"noreferrer",className:"mt-1 ml-2 block no-underline",children:(0,s.jsxs)("div",{className:"flex items-center justify-start gap-2",children:[n,(0,s.jsxs)("div",{className:"mr-2 mt-1 flex justify-center items-center text-sm font-semibold text-gray-800",children:[t,(0,s.jsx)(g.o,{weight:"bold",className:"ml-1"})]})]})}),a&&(0,s.jsx)("p",{className:"mt-2 ml-6 text-sm text-gray-600 line-clamp-2",children:a||"A Khoj agent"})]})})]})})})},f=n(89417),p=n(69591);function x(e){var t,n,o,g,h,m,x,b,y;let[j,M]=(0,i.useState)(null),[C,w]=(0,i.useState)(0),[N,_]=(0,i.useState)(!0),I=(0,i.useRef)(null),S=(0,i.useRef)(null),k=(0,i.useRef)(null),H=(0,i.useRef)(null),[T,E]=(0,i.useState)(null),[L,q]=(0,i.useState)(!1),[O,A]=(0,i.useState)(!0),R=(0,p.IC)(),Q="[data-radix-scroll-area-viewport]";(0,i.useEffect)(()=>{var e;let t=null===(e=S.current)||void 0===e?void 0:e.querySelector(Q);if(!t)return;let n=()=>{let{scrollTop:e,scrollHeight:n,clientHeight:s}=t;A(n-(e+s)<=50)};return t.addEventListener("scroll",n),()=>t.removeEventListener("scroll",n)},[]),(0,i.useEffect)(()=>{e.incomingMessages&&e.incomingMessages.length>0&&O&&Z()},[e.incomingMessages,O]),(0,i.useEffect)(()=>{j&&j.chat&&j.chat.length>0&&C<2&&requestAnimationFrame(()=>{var e;null===(e=k.current)||void 0===e||e.scrollIntoView({behavior:"auto",block:"start"})})},[j,C]),(0,i.useEffect)(()=>{if(!N||L)return;let t=new IntersectionObserver(t=>{t[0].isIntersecting&&N&&(q(!0),function(t){if(!N||L)return;let n=(t+1)*10,s="";if(e.conversationId)s="/api/chat/history?client=web&conversation_id=".concat(encodeURIComponent(e.conversationId),"&n=").concat(n);else{if(!e.publicConversationSlug)return;s="/api/chat/share/history?client=web&public_conversation_slug=".concat(e.publicConversationSlug,"&n=").concat(n)}fetch(s).then(e=>e.json()).then(n=>{if(e.setTitle(n.response.slug),n&&n.response&&n.response.chat&&n.response.chat.length>0){if(w(Math.ceil(n.response.chat.length/10)),n.response.chat.length===(null==j?void 0:j.chat.length)){_(!1),q(!1);return}e.setAgent(n.response.agent),M(n.response),q(!1),0===t?Z(!0):W()}else{if(n.response.agent&&n.response.conversation_id){let t={chat:[],agent:n.response.agent,conversation_id:n.response.conversation_id,slug:n.response.slug};e.setAgent(n.response.agent),M(t)}_(!1),q(!1)}}).catch(e=>{console.error(e),window.location.href="/"})}(C))},{threshold:1});return I.current&&t.observe(I.current),()=>t.disconnect()},[N,C,L]),(0,i.useEffect)(()=>{_(!0),q(!1),w(0),M(null)},[e.conversationId]),(0,i.useEffect)(()=>{if(e.incomingMessages){let t=e.incomingMessages[e.incomingMessages.length-1];t&&!t.completed&&(E(e.incomingMessages.length-1),e.setTitle(t.rawQuery))}},[e.incomingMessages]);let W=()=>{var e;let t=null===(e=S.current)||void 0===e?void 0:e.querySelector(Q);requestAnimationFrame(()=>{var e;null===(e=H.current)||void 0===e||e.scrollIntoView({behavior:"auto",block:"start"}),null==t||t.scrollBy({behavior:"smooth",top:-150})})},Z=function(){var e;let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],n=null===(e=S.current)||void 0===e?void 0:e.querySelector(Q);requestAnimationFrame(()=>{null==n||n.scrollTo({top:n.scrollHeight,behavior:t?"auto":"smooth"})}),A(!0)};return e.conversationId||e.publicConversationSlug?(0,s.jsx)(r.x,{className:"h-[80vh] relative",ref:S,children:(0,s.jsxs)("div",{children:[(0,s.jsxs)("div",{className:"".concat(a().chatHistory," ").concat(e.customClassName),children:[(0,s.jsx)("div",{ref:I,style:{height:"1px"},children:L&&(0,s.jsx)(c.l,{message:"Loading Conversation",className:"opacity-50"})}),j&&j.chat&&j.chat.map((e,t)=>{var n;return(0,s.jsx)(l.Z,{ref:t===j.chat.length-2?k:t===j.chat.length-(C-1)*10?H:null,isMobileWidth:R,chatMessage:e,customClassName:"fullHistory",borderLeftColor:"".concat(null==j?void 0:null===(n=j.agent)||void 0===n?void 0:n.color,"-500"),isLastMessage:t===j.chat.length-1},"".concat(t,"fullHistory"))}),e.incomingMessages&&e.incomingMessages.map((e,t)=>{var n,o,r;return(0,s.jsxs)(i.Fragment,{children:[(0,s.jsx)(l.Z,{isMobileWidth:R,chatMessage:{message:e.rawQuery,context:[],onlineContext:{},created:e.timestamp,by:"you",automationId:"",images:e.images},customClassName:"fullHistory",borderLeftColor:"".concat(null==j?void 0:null===(n=j.agent)||void 0===n?void 0:n.color,"-500")},"".concat(t,"outgoing")),e.trainOfThought&&function(e,t,n,o){let i=arguments.length>4&&void 0!==arguments[4]&&arguments[4],r=e.length-1;return(0,s.jsxs)("div",{className:"".concat(a().trainOfThought," shadow-sm"),children:[!i&&(0,s.jsx)(c.l,{className:"float-right"}),e.map((e,o)=>(0,s.jsx)(l.H,{message:e,primary:o===r&&t&&!i,agentColor:n},"train-".concat(o)))]},o)}(e.trainOfThought,t===T,(null==j?void 0:null===(o=j.agent)||void 0===o?void 0:o.color)||"orange","".concat(t,"trainOfThought"),e.completed),(0,s.jsx)(l.Z,{isMobileWidth:R,chatMessage:{message:e.rawResponse,context:e.context,onlineContext:e.onlineContext,created:e.timestamp,by:"khoj",automationId:"",rawQuery:e.rawQuery,intent:{type:e.intentType||"",query:e.rawQuery,"memory-type":"","inferred-queries":e.inferredQueries||[]}},customClassName:"fullHistory",borderLeftColor:"".concat(null==j?void 0:null===(r=j.agent)||void 0===r?void 0:r.color,"-500"),isLastMessage:!0},"".concat(t,"incoming"))]},"incomingMessage".concat(t))}),e.pendingMessage&&(0,s.jsx)(l.Z,{isMobileWidth:R,chatMessage:{message:e.pendingMessage,context:[],onlineContext:{},created:new Date().getTime().toString(),by:"you",automationId:""},customClassName:"fullHistory",borderLeftColor:"".concat(null==j?void 0:null===(t=j.agent)||void 0===t?void 0:t.color,"-500"),isLastMessage:!0},"pendingMessage-".concat(e.pendingMessage.length)),j&&(0,s.jsx)("div",{className:"".concat(a().agentIndicator," pb-4"),children:(0,s.jsx)("div",{className:"relative group mx-2 cursor-pointer",children:(0,s.jsx)(v,{name:j&&j.agent&&(null===(g=j.agent)||void 0===g?void 0:g.name)?null===(h=j.agent)||void 0===h?void 0:h.name:"Agent",link:j&&j.agent&&(null===(m=j.agent)||void 0===m?void 0:m.slug)?"/agents?agent=".concat(null===(x=j.agent)||void 0===x?void 0:x.slug):"/agents",avatar:(0,f.TI)(null===(n=j.agent)||void 0===n?void 0:n.icon,null===(o=j.agent)||void 0===o?void 0:o.color)||(0,s.jsx)(u.v,{}),description:j&&j.agent&&(null===(b=j.agent)||void 0===b?void 0:b.persona)?null===(y=j.agent)||void 0===y?void 0:y.persona:"Your agent is no longer available. You will be reset to the default agent."})})})]}),(0,s.jsx)("div",{className:"".concat(e.customClassName," fixed bottom-[15%] z-10"),children:!O&&(0,s.jsx)("button",{title:"Scroll to bottom",className:"absolute bottom-0 right-0 bg-white dark:bg-[hsl(var(--background))] text-neutral-500 dark:text-white p-2 rounded-full shadow-xl",onClick:()=>{Z(),A(!0)},children:(0,s.jsx)(d.K,{size:24})})})]})}):null}},15238:function(e){e.exports={chatHistory:"chatHistory_chatHistory__CoaVT",agentIndicator:"chatHistory_agentIndicator__wOU1f",trainOfThought:"chatHistory_trainOfThought__mMWSR"}}}]);