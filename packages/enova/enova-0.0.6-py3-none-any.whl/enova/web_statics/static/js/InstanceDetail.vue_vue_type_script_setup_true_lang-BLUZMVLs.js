import{d as A,c as C,a as g,W as j,o as _,r as y,S as H,u as Z,O as o,R as c,F as Ue,e as B,P as U,a8 as F,V as xe,X as _e,w as se,k as be,L as me,$ as pe,a0 as de,n as ye,U as Pe}from"./@vue-BH9fzvyO.js";import{O as Ce,P as Be,Q as Fe,o as ke,K as He,L as Oe,u as De,v as Te,R as Ye,A as Ge,B as Ae,p as Ke,t as Qe,x as We,y as $e,J as Je,C as Xe,H as Ze,f as et,g as tt,S as at,T as nt,M as st,N as lt}from"./element-plus-3B-vNOz1.js";import{y as qe,f as ot,z as rt}from"./@element-plus-B4MVEBIT.js";import{u as ve}from"./vue-i18n-CgiZb_CK.js";import{d as Se,s as ee}from"./pinia-DJ7zjen1.js";import{a as it}from"./axios-B6xwUs71.js";import{_ as Me}from"./index-D14IUlo4.js";import{d as J,u as Ee}from"./dayjs-DxDECbvV.js";import{b as he}from"./@vueuse-DzyAV02C.js";import{u as ut,i as ct,a as mt,b as pt,c as dt,d as _t,e as ht,f as vt,g as gt}from"./echarts-BNE_GihJ.js";const ft={class:"text-base text-primary font-semibold leading-6 px-5 py-3 -mx-5 border-b border-gray2"},yt={class:"ml-1 text-gray5"},va=A({__name:"SummaryTip",props:{title:{},count:{}},setup(e){return(n,r)=>(_(),C("div",ft,[g("span",null,j(n.title),1),g("span",yt,"("+j(n.count)+")",1)]))}}),ga=A({__name:"SearchInput",props:{searchTips:{type:String,default:""}},emits:["changeSearch"],setup(e,{emit:n}){const r=y(""),a=n,v=()=>{a("changeSearch",r.value.trim())};return(s,p)=>{const x=Ce;return _(),H(x,{modelValue:r.value,"onUpdate:modelValue":p[0]||(p[0]=t=>r.value=t),"prefix-icon":Z(qe),style:{width:"560px"},clearable:"",placeholder:e.searchTips,class:"input-with-select",onChange:v},null,8,["modelValue","prefix-icon","placeholder"])}}}),bt={class:"page-container pt-3"},xt=A({__name:"Pagination",props:{pagination:{type:Object,required:!0,default:()=>({current_page:1,page_count:1,total:0})},pageSize:{type:Number,required:!1,default:20},layout:{type:String,required:!1,default:"total, sizes, prev, pager, next, jumper"}},emits:["update:pageChanged"],setup(e,{emit:n}){const r=e,a=n,v=p=>{p!==r.pagination.pageSize&&(r.pagination.pageSize=p,a("update:pageChanged",p))},s=p=>{p!==r.pagination.current_page&&(r.pagination.current_page=p,a("update:pageChanged",p))};return(p,x)=>{const t=Be;return _(),C("div",bt,[o(t,{"current-page":e.pagination.current_page,"page-sizes":[10,20,30,50,80],"page-size":e.pagination.pageSize??20,layout:e.layout,"page-count":e.pagination.page_count,total:e.pagination.total,"hide-on-single-page":!1,onSizeChange:v,onCurrentChange:s},null,8,["current-page","page-size","layout","page-count","total"])])}}}),kt={class:"inline-flex items-center gap-1"},wt={class:"text-base font-bold text-[#1D2129]"},Ct={class:"text-sm text-[#86909C]"},fa=A({__name:"Drawer",props:{showDrawer:{type:Boolean,default:!1},title:{type:String,default:""},titleDesc:{type:String,default:""},size:{type:String,default:"50%"}},emits:["closeDrawer"],setup(e,{emit:n}){const r=n,a=()=>{r("closeDrawer",!1)};return(v,s)=>{const p=Fe;return _(),H(p,{"model-value":e.showDrawer,"close-on-click-modal":!1,"close-on-press-escape":!1,size:e.size,class:"enova-drawer","custom-class":"enova-drawer",onClose:a},{header:c(()=>[g("p",kt,[g("span",wt,j(e.title),1),g("span",Ct,"- "+j(e.titleDesc),1)])]),default:c(()=>[Ue(v.$slots,"default")]),_:3},8,["model-value","size"])}}}),X=it.create({baseURL:"/",timeout:1e4});X.interceptors.request.use(e=>e,e=>Promise.reject(e));X.interceptors.response.use(e=>{var r,a;const n=e.data;return Number(n.code)===0||n.status==="success"?n.code===0?n.result:n:(ke({message:((a=(r=n.response)==null?void 0:r.data)==null?void 0:a.message)||n.message||"Error",type:"error",duration:5*1e3}),Promise.reject(n))},e=>{var n,r;return ke({message:((r=(n=e.response)==null?void 0:n.data)==null?void 0:r.message)||e.message||"Error",type:"error",duration:5*1e3}),Promise.reject(e)});const Dt=()=>X({url:"/v1/serving",method:"get"}),ya=e=>X({url:`/v1/serving/${e}`,method:"delete"}),Tt=e=>X({url:`/v1/serving/instance/test?${e}`,method:"get"}),ba=e=>X({url:"/v1/serving/instance/test",method:"post",data:e}),Ve=e=>{const{protocol:n,hostname:r}=window.location;return`${n}//${r}:${e}/`},ze=e=>X({url:`/api/v1/query_range?${e}`,baseURL:Ve(32826),method:"get"}),$t=e=>X({url:`/api/escaler/v1/task/detect/history?${e}`,baseURL:Ve(8183),method:"get"}),le=Se("instance",{state:()=>({instanceList:[],currentId:"",chartTimeRange:[],tableLoading:!1,searchTimePair:[]}),getters:{activeInstance(){return this.instanceList.find(e=>e.instance_id===this.currentId)},instanceNameMap(){const e=new Map;return this.instanceList.forEach(n=>{e.set(n.instance_id,n.instance_name)}),e},chartQuery(){const[e,n]=this.chartTimeRange,r=e?Math.floor(new Date(e).getTime()/1e3).toFixed(3):"",a=n?Math.floor(new Date(n).getTime()/1e3).toFixed(3):"";return{start:r,end:a,step:"15s"}},activeServingId(){var e;return this.activeInstance!=null?this.activeInstance.serving_id:((e=this.instanceList[0])==null?void 0:e.serving_id)??""},activeServingJob(){var e;return this.activeInstance!=null?this.activeInstance.startup_args.exported_job:((e=this.instanceList[0])==null?void 0:e.startup_args.exported_job)??""}},actions:{getInstanceList(){this.tableLoading=!0,Dt().then(e=>{this.instanceList=e.data}).catch(e=>{console.error(e)}).finally(()=>{this.tableLoading=!1})}}}),qt={class:"collapse-title"},St={class:"collapse-title"};const Mt=A({__name:"BaseInfo",setup(e){const{t:n}=ve(),r=le(),{activeInstance:a}=ee(r),v=y(["parameters","specifications"]),s=B(()=>{const{startup_args:t}=a.value??{startup_args:null};return[{key:"Exported_job",value:(t==null?void 0:t.exported_job)??"-"},{key:"Dtype",value:(t==null?void 0:t.dtype)??"-"},{key:"Load_format",value:(t==null?void 0:t.load_format)??"-"},{key:"Max_num_batched_tokens",value:(t==null?void 0:t.max_num_batched_tokens)??"-"},{key:"Max_num_seqs",value:(t==null?void 0:t.max_num_seqs)??"-"},{key:"Max_paddings",value:(t==null?void 0:t.max_paddings)??"-"},{key:"Max_seq_len",value:(t==null?void 0:t.max_seq_len)??"-"},{key:"Model",value:(t==null?void 0:t.model)??"-"},{key:"Tokenizer",value:(t==null?void 0:t.tokenizer)??"-"},{key:"Pipeline_parallel_size",value:(t==null?void 0:t.pipeline_parallel_size)??"-"},{key:"Tensor_parallel_size",value:(t==null?void 0:t.tensor_parallel_size)??"-"},{key:"Quantization",value:(t==null?void 0:t.quantization)??"-"}]}),p=B(()=>{const{instance_spec:t}=a.value??{instance_spec:null};return[{key:"GPU",value:(t==null?void 0:t.gpu.product)??"-"},{key:"CPU",value:(t==null?void 0:t.cpu.brand_name)??"-"},{key:n("instance.title.memory"),value:(t==null?void 0:t.memory)??"-"}]}),x=[{key:n("instance.title.imageSource"),value:"Base Image"},{key:n("instance.title.image"),value:"Python Version: 3.8 / PyTorch Version: 2.1.0 / CUDA Version: 12.2"}];return(t,i)=>{const l=He,$=Oe,I=De,P=Te;return _(),H(P,{modelValue:v.value,"onUpdate:modelValue":i[0]||(i[0]=D=>v.value=D)},{default:c(()=>[o(I,{name:"parameters"},{title:c(()=>[g("span",qt,j(t.$t("instance.title.startupOptions")),1)]),default:c(()=>[o($,{column:2,border:""},{default:c(()=>[(_(!0),C(U,null,F(s.value,D=>(_(),H(l,{key:D.key,label:D.key,width:"25%"},{default:c(()=>[xe(j(D.value),1)]),_:2},1032,["label"]))),128))]),_:1})]),_:1}),o(I,{name:"specifications"},{title:c(()=>[g("span",St,j(t.$t("instance.title.instanceSpec")),1)]),default:c(()=>[o($,{column:2,border:""},{default:c(()=>[(_(!0),C(U,null,F(p.value,D=>(_(),H(l,{key:D.key,label:D.key,width:"25%"},{default:c(()=>[xe(j(D.value),1)]),_:2},1032,["label"]))),128))]),_:1})]),_:1}),_e("",!0)]),_:1},8,["modelValue"])}}}),Et=A({__name:"TimeRangePicker",props:{defaultTime:{type:Array,default:()=>[],required:!1}},emits:["changTimeRange"],setup(e,{emit:n}){const r=e,{t:a}=ve(),v=y(""),s=[{text:a("datepicker.lastOneHour"),value:()=>{const i=new Date,l=new Date;return l.setTime(l.getTime()-3600*1e3*1),[l,i]}},{text:a("datepicker.lastThreeHours"),value:()=>{const i=new Date,l=new Date;return l.setTime(l.getTime()-3600*1e3*3),[l,i]}},{text:a("datepicker.lastTwelveHours"),value:()=>{const i=new Date,l=new Date;return l.setTime(l.getTime()-3600*1e3*12),[l,i]}},{text:a("datepicker.lastTwentyFourHours"),value:()=>{const i=new Date,l=new Date;return l.setTime(l.getTime()-3600*1e3*24),[l,i]}},{text:a("datepicker.lastTwoDays"),value:()=>{const i=new Date,l=new Date;return l.setTime(l.getTime()-3600*1e3*24*2),[l,i]}},{text:a("datepicker.lastSevenDays"),value:()=>{const i=new Date,l=new Date;return l.setTime(l.getTime()-3600*1e3*24*7),[l,i]}},{text:a("datepicker.lastMonth"),value:()=>{const i=new Date,l=new Date;return l.setTime(l.getTime()-3600*1e3*24*30),[l,i]}}],p=i=>i&&new Date(i).getTime()>Date.now(),x=n,t=()=>{x("changTimeRange",v.value)};return se(()=>r.defaultTime,i=>{i!=null&&i.length>0&&(v.value=i,t())},{immediate:!0}),(i,l)=>{const $=Ye;return _(),H($,{modelValue:v.value,"onUpdate:modelValue":l[0]||(l[0]=I=>v.value=I),class:"!w-full",type:"datetimerange","prefix-icon":Z(ot),"range-separator":i.$t("common.title.to"),"start-placeholder":i.$t("common.title.startTime"),"end-placeholder":i.$t("common.title.endTime"),shortcuts:s,"disabled-date":p,"value-format":"YYYY-MM-DD HH:mm:ss",onChange:t},null,8,["modelValue","prefix-icon","range-separator","start-placeholder","end-placeholder"])}}}),Ie=Se("experiment",{state:()=>({testList:[],currentId:"",drawerVisible:!1}),getters:{activeExperiment:e=>e.testList.find(n=>n.test_id===e.currentId)||void 0},actions:{getTestList(e){return J.extend(Ee),new Promise((n,r)=>{Tt(e).then(a=>{this.testList=a.data.length>0?a.data.map(v=>({...v,create_time:J.utc(v.create_time).toDate()})):[],n(a)}).catch(()=>{r(null)})})}}}),Vt=(e,n)=>{switch(n){case"hour":return e*60*60;case"min":return e*60;case"sec":return Math.min(e,10);default:return 0}},we=()=>{const{activeExperiment:e}=ee(Ie()),{chartTimeRange:n,searchTimePair:r}=ee(le());J.extend(Ee);let a=new Date,v=new Date;if(e.value!=null){a=new Date(J.utc(e.value.create_time).toDate());const{duration:x,duration_unit:t}=e.value.test_spec,i=Vt(x,t);a.setTime(a.getTime()),v.setTime(Math.min(a.getTime()+(i+180)*1e3,Date.now()))}else a.setTime(a.getTime()-3600*1e3);const s=J(a).format("YYYY-MM-DD HH:mm:ss"),p=J(v).format("YYYY-MM-DD HH:mm:ss");return n.value=[s,p],r.value=[s,p],{start:s,end:p}},zt={class:"flex items-center gap-2 justify-between flex-wrap"},It={class:"flex items-center gap-2 flex-1"},Nt={class:"w-[352px] shrink-0 flex items-center"},jt={class:"min-w-[138px] flex items-center shrink-0"},Rt={class:"min-w-24 flex items-center shrink-0"},Lt=g("span",{class:"w-px block h-5 bg-[#E6E9EE]"},null,-1),Ut={class:"flex items-center gap-2"},Pt=g("span",null,[g("span",{class:"w-px block h-5 bg-[#E6E9EE]"})],-1),Bt=A({__name:"ToolBar",emits:["changeComparison","changeInterval","changeComparisonUnit","changeRefreshUnit","changeLayout","changeSearchVal","refreshChart"],setup(e,{emit:n}){const{chartTimeRange:r,searchTimePair:a}=ee(le()),{drawerVisible:v}=ee(Ie()),{t:s}=ve();let p=null;const x=y("none"),t=y(1),i=y("min"),l=y(0),$=y(1),I=y("min"),P=y(""),D=y(12),te=[{options:[{value:"none",label:s("common.title.noContrast")}]},{options:[{value:"60",label:s("common.time.lastHour")},{value:"1440",label:s("common.time.lastDay")},{value:"10080",label:s("common.time.lastWeek")},{value:"43200",label:s("common.time.lastMonth")}]},{options:[{value:"custom",label:s("common.title.customContrast")}]}],W=[{options:[{value:0,label:s("common.title.noRefresh")}]},{options:[{label:"1m",value:60},{label:"5m",value:300},{label:"30m",value:1800},{label:"1h",value:3600}]},{options:[{value:"custom",label:s("common.title.customRefresh")}]}],h=[{value:24,label:1},{value:12,label:2},{value:8,label:3},{value:6,label:4}],k=[{value:"sec",label:s("common.time.second")},{value:"min",label:s("common.time.minute")},{value:"hour",label:s("common.time.hour")}],N=[{value:"min",label:s("common.time.minute")},{value:"hour",label:s("common.time.hour")},{value:"day",label:s("common.time.day")},{value:"week",label:s("common.time.week")}],E=n,T=(b,m)=>{const L=Number(b);switch(m){case"sec":return L;case"min":return L*60;case"hour":return L*60*60;case"day":return L*60*60*24;case"week":return L*60*60*24*7;default:throw new Error("Invalid unit")}},V=he(b=>{const m=T(b,I.value);ae(m)},1e3),R=b=>{b==="sec"&&($.value=Math.max(10,$.value));const m=T($.value,b);ae(m)},O=b=>{E("changeComparison",Number(b))},w=he(b=>{const m=T(b,i.value);O(m)},1e3),q=b=>{const m=T(t.value,b);O(m)},ae=b=>{if(oe(),b===0)return;let m=b;b==="custom"&&(m=T($.value,I.value)),p=setInterval(()=>{ie()},Number(m)*1e3)},oe=()=>{p&&(clearInterval(p),p=null)},re=()=>{E("changeSearchVal",P.value)},ge=()=>{E("changeLayout",D.value)},K=b=>{r.value=[J(new Date(b[0])).format("YYYY-MM-DD HH:mm:ss"),J(Math.min(new Date(b[1]).getTime(),Date.now())).format("YYYY-MM-DD HH:mm:ss")]},ie=()=>{we(),E("refreshChart")};return be(()=>{we()}),se(()=>v.value,b=>{b||oe()}),(b,m)=>{const L=Ge,u=Ae,f=Ke,S=Qe,M=Me,Y=We,fe=$e,ue=Ce;return _(),C("div",zt,[g("div",It,[g("div",Nt,[o(Et,{"default-time":Z(a),onChangTimeRange:K,clearable:!1},null,8,["default-time"])]),g("div",jt,[o(f,{modelValue:x.value,"onUpdate:modelValue":m[0]||(m[0]=d=>x.value=d),class:me({"cus-select-l":x.value==="custom"}),placeholder:"",onChange:O},{default:c(()=>[(_(),C(U,null,F(te,(d,ne)=>o(u,{key:ne},{default:c(()=>[(_(!0),C(U,null,F(d.options,Q=>(_(),H(L,{key:Q.value,label:Q.label,value:Q.value},null,8,["label","value"]))),128))]),_:2},1024)),64))]),_:1},8,["modelValue","class"]),pe(o(S,{modelValue:t.value,"onUpdate:modelValue":m[1]||(m[1]=d=>t.value=d),class:"numInput",min:1,"controls-position":"right",onChange:Z(w)},null,8,["modelValue","onChange"]),[[de,x.value==="custom"]]),pe(o(f,{modelValue:i.value,"onUpdate:modelValue":m[2]||(m[2]=d=>i.value=d),class:me(["!w-16 shrink-0",{"cus-select-r":x.value==="custom"}]),placeholder:"",onChange:q},{default:c(()=>[(_(),C(U,null,F(N,d=>o(L,{key:d.value,label:d.label,value:d.value},null,8,["label","value"])),64))]),_:1},8,["modelValue","class"]),[[de,x.value==="custom"]])]),g("div",Rt,[o(f,{modelValue:l.value,"onUpdate:modelValue":m[3]||(m[3]=d=>l.value=d),class:me(["autoRefreshSelect",{"cus-select-l":l.value==="custom"}]),placeholder:"",onChange:ae},{prefix:c(()=>[o(M,{name:l.value==="0"?"autoRefresh":"auto",size:"14"},null,8,["name"]),Lt]),default:c(()=>[(_(),C(U,null,F(W,(d,ne)=>o(u,{key:ne},{default:c(()=>[(_(!0),C(U,null,F(d.options,Q=>(_(),H(L,{key:Q.value,label:Q.label,value:Q.value},null,8,["label","value"]))),128))]),_:2},1024)),64))]),_:1},8,["modelValue","class"]),pe(o(S,{modelValue:$.value,"onUpdate:modelValue":m[4]||(m[4]=d=>$.value=d),class:"numInput",min:I.value==="sec"?10:1,"controls-position":"right",onChange:Z(V)},null,8,["modelValue","min","onChange"]),[[de,l.value==="custom"]]),pe(o(f,{modelValue:I.value,"onUpdate:modelValue":m[5]||(m[5]=d=>I.value=d),class:me(["!w-16 shrink-0",{"cus-select-r":l.value==="custom"}]),placeholder:"",onChange:R},{default:c(()=>[(_(),C(U,null,F(k,d=>o(L,{key:d.value,label:d.label,value:d.value},null,8,["label","value"])),64))]),_:1},8,["modelValue","class"]),[[de,l.value==="custom"]])]),o(fe,{effect:"dark",content:b.$t("common.action.refresh"),placement:"top"},{default:c(()=>[o(Y,{icon:Z(rt),class:"size-8",onClick:ie},null,8,["icon"])]),_:1},8,["content"])]),g("div",Ut,[o(ue,{modelValue:P.value,"onUpdate:modelValue":m[6]||(m[6]=d=>P.value=d),"prefix-icon":Z(qe),class:"input-with-select",style:{width:"320px"},clearable:"",placeholder:b.$t("instance.inst.chartSearch"),onChange:re},null,8,["modelValue","prefix-icon","placeholder"]),Pt,o(f,{modelValue:D.value,"onUpdate:modelValue":m[7]||(m[7]=d=>D.value=d),class:"layoutSelect !w-8",placeholder:"",onChange:ge},{prefix:c(()=>[o(M,{name:"setup",size:"14"})]),default:c(()=>[(_(),C(U,null,F(h,d=>o(L,{key:d.value,label:d.label,value:d.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])])])}}}),Ft="/static/png/empty-U7Kz5nn2.png",Ht={key:0,class:"absolute top-2 left-0 w-full h-full p-2 gap-2 pointer-events-none flex flex-col justify-center items-center"},Ot=g("img",{src:Ft,class:"object-contain max-h-[60%]",alt:""},null,-1),Yt=A({__name:"LineChart",props:{chartTitle:{type:String,default:""},queryParams:{type:String,default:""},queryStep:{type:String,require:!1,default:"60s"},unit:{type:String,default:"%"},searchVal:{type:String,default:""},compareTime:{type:Number,default:0,required:!1},seriesName:{type:String,default:"",required:!1},groupName:{type:String,default:"",required:!1}},emits:["update:unit"],setup(e,{expose:n,emit:r}){ut([ct,mt,pt,dt,_t,ht,vt]);const{chartQuery:a,activeServingJob:v}=ee(le()),s=e,p=r,x=y(),t=y([]),i=B(()=>({tooltip:{trigger:"axis",axisPointer:{type:"cross"},confine:!0,enterable:!1},legend:{show:!0,type:"scroll",bottom:0,left:8,itemWidth:16,itemHeight:6},grid:{left:"16px",right:"16px",top:"50px",bottom:"20px",containLabel:!0},xAxis:[{type:"time",show:t.value.length>0,axisLabel:{interval:50,hideOverlap:!0}},{type:"time",show:s.compareTime>0&&t.value.length>0,axisLabel:{interval:50,hideOverlap:!0}}],yAxis:{type:"value"},series:t.value})),l=h=>{const N=h.reduce((V,R)=>Array.isArray(R)?(isNaN(V)?0:V)+R.reduce((O,w)=>O+(isNaN(w)?0:w),0):(isNaN(V)?0:V)+(isNaN(R)?0:R),0)/(h.length||1),E=["B/s","KB/s","MB/s","GB/s","TB/s"],T=Math.min(E.length-1,Math.floor(Math.log10(N)/3));return{size:Math.pow(1024,T),unit:E[T]}},$=(h,k)=>s.unit==="s"?Number(h/1e3).toFixed(3):s.unit==="GB"?Number(h/1024/1024/1024).toFixed(3):s.unit==="MB/s"?k===0?Number(h/1024/1024).toFixed(3):Number(h/(k??1)).toFixed(3):s.unit==="MHz"?Number(h/1e6).toFixed(3):Number(h).toFixed(3),I=async h=>{if(s.queryParams==="")return[];const{start:k,end:N}=a.value;let E=k,T=N;h&&(E=(Number(k)-h)*1e3/1e3,T=(Number(N)-h)*1e3/1e3);const V=`query=${s.queryParams}&start=${E}&end=${T}&step=${s.queryStep}`;return(await ze(V)).data.result},P=y(null),D=async()=>{x.value!=null&&x.value.dispose();const h=gt(P.value);x.value=h,h.showLoading();let k=[],N=[];try{k=await I(),s.compareTime>0&&(N=await I(s.compareTime))}catch{k=[],N=[]}let E=0;if(s.unit==="MB/s"){const{size:T,unit:V}=l(k.map(R=>R.values.map(O=>Number(O[1]))));E=T,V!=null&&p("update:unit",V)}if(k!=null&&k.length>0){const T=s.seriesName==="exported_job"?k.filter(w=>{var q;return w.metric.exported_job!=null?(q=w.metric.exported_job)==null?void 0:q.includes(v.value):w}):k,V=s.seriesName==="exported_job"?N.filter(w=>{var q;return w.metric.exported_job!=null?(q=w.metric.exported_job)==null?void 0:q.includes(v.value):w}):N,R=T.map(w=>({name:w.metric[s.seriesName]??"value",type:"line",smooth:!0,emphasis:{focus:"series"},symbol:"circle",symbolSize:4,data:w.values.map(q=>[Number(q[0])*1e3,$(q[1],E)])})),O=V.map(w=>({name:w.metric[s.seriesName]??"value",type:"line",xAxisIndex:1,data:w.values.map(q=>[Number(q[0])*1e3,$(q[1])])}));t.value=[...R,...O]}else t.value=[],h.clear();h.setOption(i.value),h.hideLoading()},te=()=>{ye(()=>{var h;(h=x.value)==null||h.resize({animation:{duration:200,easing:"linear"}})})},W=he(()=>D(),300);return n({resizeChart:te,initChart:W,groupName:s.groupName}),be(()=>{D()}),se(()=>a.value,(h,k)=>{k.start!==""&&JSON.stringify(h)!==JSON.stringify(k)&&W()}),se(()=>s.compareTime,async()=>{W()}),(h,k)=>(_(),C(U,null,[g("div",{ref_key:"chartContainer",ref:P,class:"bg-white rounded",style:{width:"100%",height:"240px"}},null,512),t.value.length===0?(_(),C("div",Ht,[Ot,g("span",null,j(h.$t("chart.title.noData")),1)])):_e("",!0)],64))}}),Gt={class:"py-5 px-6 flex flex-col gap-5 h-full max-h-[calc(100vh-136px)] overflow-hidden"},At={key:0,class:"flex gap-2 items-center py-2 px-4 bg-[#E6F4FF] text-sm"},Kt={class:"text-secondary cursor-pointer"},Qt={class:"flex flex-col"},Wt={class:"py-3"},Jt={class:"text-black1 text-sm"},Xt={class:"flex-1 w-[calc(100%-164px)]"},Zt={class:"collapse-title"},ea={class:"px-4 bg-gray3"},ta={class:"absolute top-4 left-6 w-[calc(100%-46px)] z-10 text-black1 flex items-center select-none text-xs"},aa={class:"font-bold truncate inline-block max-w-[80%]"},na={key:0,class:"text-gray4 pl-1"},sa={class:"enova-anchor w-[164px] h-full pl-5"},la=A({__name:"GpuInfo",setup(e){const{chartQuery:n,activeServingId:r}=ee(le()),{t:a}=ve(),v=y(null),s=y(),p=y(),x=y(2e3),t=y(12),i=[{key:"api",value:"API"},{key:"llm",value:"LLM"},{key:"gpu",value:"GPU"},{key:"memory",value:"Memory"},{key:"clock",value:"Clock"},{key:"power",value:"Temperature & Power"},{key:"profiling",value:"Profiling"},{key:"cuda",value:"CUDA XID"}],l=y(null),$=y(new Map),I=(u,f,S)=>{$.value.set(`${u.key}-${f}`,S)},P=y(i.map(u=>u.value)),D=B(()=>{const u=m.value.length>0?m.value[0]:{configRecommendResult:{gpu_memory_utilization:0,max_num_seqs:0,replicas:0,tensor_parallel_size:0},currentConfig:{gpu_memory_utilization:0,max_num_seqs:0,replicas:0,tensor_parallel_size:0},isAnomaly:!0,timestamp:0},{configRecommendResult:f,currentConfig:S}=u;return[{data:"batch size",current:S.max_num_seqs,recommend:f.max_num_seqs},{data:"tensor_parallel_size",current:S.tensor_parallel_size,recommend:f.tensor_parallel_size},{data:"gpu_memory_utilization",current:S.gpu_memory_utilization,recommend:f.gpu_memory_utilization},{data:"replicas num",current:S.replicas,recommend:f.replicas}]}),te=B(()=>K([{title:a("chart.title.requestNum"),query:"sum(rate(http_server_requests_total{}[1m])) by (exported_job)",step:"60s",unit:"",name:"exported_job"},{title:a("chart.title.requestExecuteNum"),query:"sum(rate(http_server_response_size_bytes_count{}[1m])) by (exported_job)",step:"60s",unit:"",name:"exported_job"},{title:a("chart.title.requestSuccessNum"),query:'sum(rate(http_server_response_size_bytes_count{http_status_code=~"2.."}[1m])) by (exported_job)',step:"60s",unit:"",name:"exported_job"},{title:a("chart.title.requestSuccessRate"),query:'sum(rate(http_server_response_size_bytes_count{http_status_code=~"2.."}[1m])) by (exported_job) / sum(rate(http_server_response_size_bytes_count{}[1m])) by (exported_job) * 100',step:"60s",unit:"%",name:"exported_job"},{title:a("chart.title.activeRequestNum"),query:"sum(http_server_active_requests{}) by (exported_job)",unit:"",name:"exported_job"},{title:a("chart.title.requestDuration"),query:"sum(rate(http_server_duration_milliseconds_sum{}[1m])) by (exported_job) / sum(rate(http_server_duration_milliseconds_count{}[1m])) by (exported_job)",unit:"s",name:"exported_job"},{title:a("chart.title.responseSize"),query:"sum(rate(http_server_response_size_bytes_sum{}[1m])) by (exported_job)",step:"60s",unit:"MB/s",name:"exported_job"},{title:a("chart.title.requestSize"),query:"sum(rate(http_server_request_size_bytes_sum{}[1m])) by(exported_job)",step:"60s",unit:"MB/s",name:"exported_job"}],"API")),W=B(()=>K([{title:a("chart.title.promptThroughput"),query:"sum (vllm:avg_prompt_throughput_toks_per_s{}) by (exported_job)",unit:"tokens/s",name:"exported_job"},{title:a("chart.title.generationThroughput"),query:"sum (vllm:avg_generation_throughput_toks_per_s{}) by (exported_job)",unit:"tokens/s",name:"exported_job"},{title:a("chart.title.runningRequests"),query:"sum (vllm:num_requests_running{}) by (exported_job)",unit:"",name:"exported_job"},{title:a("chart.title.pendingRequests"),query:"sum (vllm:num_requests_waiting{}) by (exported_job)",unit:"",name:"exported_job"},{title:a("chart.title.gpuKv"),query:"sum (vllm:gpu_cache_usage_perc{}) by (exported_job)",unit:"%",name:"exported_job"},{title:a("chart.title.timeToFirst"),query:"sum(rate(vllm:time_to_first_token_seconds_sum{}[1m])) by (exported_job) / sum(rate(vllm:time_to_first_token_seconds_count{}[1m])) by (exported_job)",unit:"ms",name:"exported_job"},{title:a("chart.title.timePerOutput"),query:"sum(rate(vllm:time_per_output_token_seconds_sum{}[1m])) by (exported_job) / sum(rate(vllm:time_per_output_token_seconds_count{}[1m])) by (exported_job)",unit:"ms",name:"exported_job"}],"LLM")),h=B(()=>K([{title:a("chart.title.gpuRate"),query:"DCGM_FI_DEV_GPU_UTIL",unit:"%",name:"device"}],"GPU")),k=B(()=>K([{title:a("chart.title.memRate"),query:"DCGM_FI_DEV_MEM_COPY_UTIL",unit:"%",name:"device"},{title:a("chart.title.fbNum"),query:"DCGM_FI_DEV_FB_USED",unit:"GB",name:"device"}],"Memory")),N=B(()=>K([{title:a("chart.title.smClock"),query:"DCGM_FI_DEV_SM_CLOCK * 1000000",unit:"MHz",name:"device"},{title:a("chart.title.memClock"),query:"DCGM_FI_DEV_MEM_CLOCK * 1000000",unit:"MHz",name:"device"}],"Clock")),E=B(()=>K([{title:a("chart.title.memTemp"),query:"avg by(device) (DCGM_FI_DEV_MEMORY_TEMP)",unit:"℃",name:"device"},{title:a("chart.title.gpuTemp"),query:"avg by(device) (DCGM_FI_DEV_GPU_TEMP)",unit:"℃",name:"device"},{title:a("chart.title.power"),query:"DCGM_FI_DEV_POWER_USAGE",unit:"W",name:"device"}],"Temperature & Power")),T=B(()=>K([{title:a("chart.title.grEnginActive"),query:"",unit:"%"},{title:a("chart.title.tensor"),query:"",unit:"%"},{title:a("chart.title.memCopyUtil"),query:"",unit:"%"},{title:a("chart.title.pcie"),query:"",unit:"MB/s"},{title:a("chart.title.nvLink"),query:"",unit:"MB/s"}],"Profiling")),V=y([]),R=B(()=>[{title:"API",key:"api",charts:te.value,show:te.value.length>0},{title:"LLM",key:"llm",charts:W.value,show:W.value.length>0},{title:"GPU",key:"gpu",charts:h.value,show:h.value.length>0},{title:"Memory",key:"memory",charts:k.value,show:k.value.length>0},{title:"Clock",key:"clock",charts:N.value,show:N.value.length>0},{title:"Temperature & Power",key:"power",charts:E.value,show:E.value.length>0},{title:"Profiling",key:"profiling",charts:T.value,show:T.value.length>0},{title:"CUDA XID",key:"cuda"}]),O=u=>{u.preventDefault()},w=u=>{t.value=Number(u),(l.value??[]).forEach(f=>{f.resizeChart()})},q=y(""),ae=u=>{q.value=u},oe=()=>{(l.value??[]).forEach(u=>{u.initChart()})},re=y(0),ge=u=>{re.value=u*60},K=(u,f)=>u.filter(S=>f.toLowerCase().includes(q.value.toLowerCase())||S.title.toLowerCase().includes(q.value.toLowerCase())),ie=he(()=>{ye(()=>{x.value=s.value.offsetHeight,w(t.value)})},300,{maxWait:3e3}),b=async()=>{const{start:u,end:f,step:S}=n.value,M=`query=count(DCGM_FI_DEV_XID_ERRORS > 0)&start=${u}&end=${f}&step=${S}&timeShift=30m`,Y=await ze(M);V.value=Y.data.result},m=y([]),L=async()=>{const u=`task_name=${r.value}`;try{const f=await $t(u);m.value=f.data}catch{m.value=[]}};return be(()=>{ye(()=>{var u;x.value=s.value.offsetHeight,(u=p.value)==null||u.scrollTo("#api")}),L(),b(),window.addEventListener("resize",ie)}),se(()=>P.value,(u,f)=>{if(u.length>f.length){const S=u.filter(M=>!f.includes(M));if(S.length>0&&l.value!=null){const M=l.value.filter(Y=>Y.groupName===S[0]);M.length>0&&M.forEach(Y=>Y.resizeChart())}}}),(u,f)=>{const S=Me,M=Je,Y=Xe,fe=Ze,ue=et,d=$e,ne=tt,Q=De,Ne=Te,je=at,Re=nt;return _(),C("section",Gt,[o(Bt,{onChangeLayout:w,onChangeSearchVal:ae,onRefreshChart:oe,onChangeComparison:ge}),m.value.length>0?(_(),C("div",At,[o(S,{name:"info",class:"shrink-0 text-secondary"}),o(fe,{placement:"bottom",width:500,"popper-class":"p-3",trigger:"click"},{reference:c(()=>[g("span",Kt,j(u.$t("instance.title.configSuggest")),1)]),default:c(()=>[g("div",Qt,[g("div",Wt,[g("span",Jt,j(u.$t("instance.title.configSuggest")),1)]),o(Y,{data:D.value,class:"configTable",width:"500px"},{default:c(()=>[o(M,{width:"165px",property:"data"}),o(M,{property:"current",label:u.$t("instance.title.currentVal")},null,8,["label"]),o(M,{property:"recommend",label:u.$t("instance.title.suggestVal")},null,8,["label"])]),_:1},8,["data"])])]),_:1})])):_e("",!0),g("section",{class:"flex-1 overflow-hidden flex w-full",ref_key:"containerRef",ref:s},[g("section",Xt,[g("div",{class:"h-60 overflow-auto",ref_key:"containerRef1",ref:v,style:Pe({height:x.value+"px"})},[o(Ne,{modelValue:P.value,"onUpdate:modelValue":f[0]||(f[0]=z=>P.value=z)},{default:c(()=>[(_(!0),C(U,null,F(R.value,z=>(_(),H(Q,{key:z.title,name:z.title,id:z.key,class:"first:mt-0"},{title:c(()=>[g("span",Zt,j(z.title),1)]),default:c(()=>[g("div",ea,[o(ne,{gutter:16},{default:c(()=>[z.key==="cuda"?(_(),H(ue,{key:0,span:24,class:"pb-6 pt-2"},{default:c(()=>[o(Y,{data:V.value,class:"enova-table"},{default:c(()=>[o(M,{prop:"time",label:u.$t("common.title.time"),sortable:"","sort-orders":["ascending","descending"]},null,8,["label"]),o(M,{prop:"xid",label:"ID"}),o(M,{prop:"failure",label:u.$t("common.title.failure")},null,8,["label"]),o(M,{prop:"causes",label:u.$t("common.title.causes")},null,8,["label"])]),_:1},8,["data"]),o(xt,{layout:"total, prev, pager, next",pagination:{current_page:1,page_count:1,total:0}})]),_:1})):(_(!0),C(U,{key:1},F(z.charts,(G,ce)=>(_(),H(ue,{key:ce,span:t.value,class:"mb-4 relative"},{default:c(()=>[o(d,{effect:"dark",content:G.title,placement:"bottom","show-after":100},{default:c(()=>[g("div",ta,[g("span",aa,j(G.title),1),G.unit&&G.unit!==""?(_(),C("span",na,"("+j($.value.get(`${z.key}-${ce}`)??G.unit)+")",1)):_e("",!0)])]),_:2},1032,["content"]),o(Yt,{ref_for:!0,ref_key:"chartRef",ref:l,"chart-title":G.title,"query-params":G.query,"query-step":G.step,unit:$.value.get(`${z.key}-${ce}`)??G.unit,"search-val":q.value,"compare-time":re.value,"series-name":G.name,"group-name":z.title,"onUpdate:unit":Le=>I(z,ce,Le)},null,8,["chart-title","query-params","query-step","unit","search-val","compare-time","series-name","group-name","onUpdate:unit"])]),_:2},1032,["span"]))),128))]),_:2},1024)])]),_:2},1032,["name","id"]))),128))]),_:1},8,["modelValue"])],4)]),g("section",sa,[o(Re,{ref_key:"anchorRef",ref:p,container:v.value,direction:"vertical",type:"default",marker:!1,onClick:O},{default:c(()=>[(_(),C(U,null,F(i,z=>o(je,{key:z.key,href:"#"+z.key,title:z.value},null,8,["href","title"])),64))]),_:1},8,["container"])])],512)])}}}),xa=A({__name:"InstanceDetail",props:{showDrawer:{type:Boolean,default:!1}},setup(e){const n=y("baseInfo");return(r,a)=>{const v=st,s=lt;return _(),H(s,{modelValue:n.value,"onUpdate:modelValue":a[0]||(a[0]=p=>n.value=p),class:"enova-tabs h-full"},{default:c(()=>[o(v,{label:r.$t("common.title.baseInfo"),name:"baseInfo",lazy:!0},{default:c(()=>[o(Mt)]),_:1},8,["label"]),o(v,{label:r.$t("common.title.metrics"),name:"gpuInfo",class:"h-full",lazy:!0},{default:c(()=>[o(la)]),_:1},8,["label"])]),_:1},8,["modelValue"])}}});export{va as _,ga as a,xt as b,ba as c,fa as d,we as e,xa as f,ya as g,Ie as h,la as i,Et as j,le as u};
