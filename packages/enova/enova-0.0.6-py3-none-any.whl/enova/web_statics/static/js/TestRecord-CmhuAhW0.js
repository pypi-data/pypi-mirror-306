import{f as de,g as me,u as fe,v as ve,K as xe,L as he,M as ge,N as be,C as ye,D as ke,y as we,x as $e,J as Te}from"./element-plus-3B-vNOz1.js";import{h as G,i as Ce,u as De,_ as Se,a as Ie,b as Ne,e as Ve,d as Re,j as Ee,f as ze}from"./InstanceDetail.vue_vue_type_script_setup_true_lang-BLUZMVLs.js";import{_ as Me}from"./index-D14IUlo4.js";import{s as W}from"./pinia-DJ7zjen1.js";import{u as Z}from"./vue-i18n-CgiZb_CK.js";import{d as Y,r as x,e as D,o as a,S as h,R as t,O as l,a as r,W as c,c as v,P as I,a8 as E,V as U,k as Le,$ as Ue,u as P,X as b,U as Be}from"./@vue-BH9fzvyO.js";import{u as Fe,a as qe}from"./@vueuse-DzyAV02C.js";import"./lodash-es-BB-zMWwC.js";import"./async-validator-DKvM95Vc.js";import"./dayjs-DxDECbvV.js";import"./@element-plus-B4MVEBIT.js";import"./@ctrl-r5W6hzzQ.js";import"./@popperjs-D9SI2xQl.js";import"./normalize-wheel-es-B6fDCfyv.js";import"./axios-B6xwUs71.js";import"./echarts-BNE_GihJ.js";import"./tslib-BDyQ-Jie.js";import"./zrender-QwUp-Iho.js";import"./vue-router-1Rj2QA4q.js";import"./@intlify-DCihH9S3.js";const Pe={class:"collapse-title"},We=r("span",{class:"collapse-title"},"API",-1),Ye={class:"h-full flex flex-col border border-gray7 py-3 px-4 bg-white rounded"},Ae={class:"text-gray4 text-xs font-normal"},Oe={class:"mt-1 text-black1"},je={class:"font-extrabold text-2xl"},He={class:"text-xs pl-1"},Je=r("span",{class:"collapse-title"},"LLM",-1),Ke={class:"h-full flex flex-col border border-gray7 py-3 px-4 bg-white rounded"},Qe={class:"text-gray4 text-xs font-normal"},Xe={class:"mt-1 text-black1"},Ge={class:"font-extrabold text-2xl"},Ze=r("span",{class:"text-xs pl-1"},"tokens/s",-1),et={class:"collapse-title"},tt={class:"collapse-title"},st={class:"collapse-title"},at=Y({__name:"TestInfo",setup(A){const{t:e}=Z(),{activeExperiment:y}=W(G()),$=x(["result","config"]),g=x(["api","llm"]),T=x(["data","parameter"]),S=D(()=>{const{result:o,test_status:d}=y.value??{result:{success:0,total:0,elasped_avg:0},test_status:"running"};let i=o.total==null||o.total===0?0:(o.success??0)/(o.total??0)*100;i=[0,100].includes(Number(i))?Number(i):i.toFixed(3);const m=Number(o.elasped_avg??0)===0?0:(Number(o.elasped_avg??0)/1e3).toFixed(3),u=d==="success";return[{key:"requestNum",title:e("experiment.title.requestNum"),value:u?o.total??0:"-"},{key:"successNum",title:e("experiment.title.requestSuccessNum"),value:u?o.success??0:"-"},{key:"successRate",title:e("experiment.title.requestSuccessRate"),value:u?i:"-",unit:"%"},{key:"avgTime",title:e("experiment.title.avgTime"),value:u?m:"-",unit:"s"}]}),z=D(()=>{const{prompt_tps:o,generation_tps:d,test_status:i}=y.value??{prompt_tps:"-",generation_tps:"-",test_status:"running"},m=i==="success";return[{key:"prompt",title:e("experiment.title.prompt"),value:m?o??0:"-"},{key:"generation",title:e("experiment.title.generation"),value:m?d??0:"-"}]}),B=D(()=>({sec:e("common.time.second"),min:e("common.time.minute"),hour:e("common.time.hour")})),M=D(()=>{var w;const{data_set:o,duration:d,duration_unit:i,distribution:m,tps_mean:u,tps_std:C}=((w=y.value)==null?void 0:w.test_spec)||{test_spec:{data_set:"-",duration:"-",duration_unit:"min",distribution:"-",tps_mean:"-",tps_std:"-"}};return[{key:e("common.title.dataset"),value:o||"-"},{key:e("instance.title.injectTime"),value:`${d||"-"} ${B.value[i]}`},{key:e("instance.title.distribution"),value:m||"-"},{key:`Requests per Sec (${m==="poisson"?"Lambda":"Mean"})`,value:u||"-"},{key:"Requests per Sec (Std)",value:C||"-"}]}),N=D(()=>{var u;const{max_tokens:o,temperature:d,top_p:i,others:m}=((u=y.value)==null?void 0:u.param_spec)||{param_spec:{max_tokens:"-",temperature:"-",top_p:"-",others:"-"}};return[{key:"Max_tokens",value:o||"-"},{key:"Temperature",value:d||"-"},{key:"Top_p",value:i||"-"},{key:e("instance.title.otherParams"),value:m||"-"}]});return(o,d)=>{const i=de,m=me,u=fe,C=ve,w=xe,L=he;return a(),h(C,{class:"experiment pb-7",modelValue:$.value,"onUpdate:modelValue":d[2]||(d[2]=n=>$.value=n)},{default:t(()=>[l(u,{name:"result"},{title:t(()=>[r("span",Pe,c(o.$t("experiment.title.testResultOverview")),1)]),default:t(()=>[l(C,{class:"subCollapse px-5",modelValue:g.value,"onUpdate:modelValue":d[0]||(d[0]=n=>g.value=n)},{default:t(()=>[l(u,{name:"api"},{title:t(()=>[We]),default:t(()=>[l(m,{gutter:24,class:"pb-5"},{default:t(()=>[(a(!0),v(I,null,E(S.value,n=>(a(),h(i,{span:6,key:n.key},{default:t(()=>[r("div",Ye,[r("span",Ae,c(n.title),1),r("span",Oe,[r("span",je,c(n.value),1),r("span",He,c(n.unit),1)])])]),_:2},1024))),128)),l(i,{span:6})]),_:1})]),_:1}),l(u,{name:"llm"},{title:t(()=>[Je]),default:t(()=>[l(m,{gutter:24,class:"pb-5"},{default:t(()=>[(a(!0),v(I,null,E(z.value,n=>(a(),h(i,{span:6,key:n.key},{default:t(()=>[r("div",Ke,[r("span",Qe,c(n.title),1),r("span",Xe,[r("span",Ge,c(n.value),1),Ze])])]),_:2},1024))),128)),l(i,{span:6})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(u,{name:"config"},{title:t(()=>[r("span",et,c(o.$t("experiment.title.testConfig")),1)]),default:t(()=>[l(C,{class:"subCollapse p-5 hasBorder",modelValue:T.value,"onUpdate:modelValue":d[1]||(d[1]=n=>T.value=n)},{default:t(()=>[l(u,{name:"data",class:"pb-5"},{title:t(()=>[r("span",tt,c(o.$t("common.title.data")),1)]),default:t(()=>[l(L,{column:2,border:""},{default:t(()=>[(a(!0),v(I,null,E(M.value,n=>(a(),h(w,{key:n.key,label:n.key,width:"25%"},{default:t(()=>[U(c(n.value),1)]),_:2},1032,["label"]))),128))]),_:1})]),_:1}),l(u,{name:"parameter"},{title:t(()=>[r("span",st,c(o.$t("common.title.parameters")),1)]),default:t(()=>[l(L,{column:2,border:""},{default:t(()=>[(a(!0),v(I,null,E(N.value,n=>(a(),h(w,{key:n.key,label:n.key,width:"25%"},{default:t(()=>[U(c(n.value),1)]),_:2},1032,["label"]))),128))]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["modelValue"])}}}),lt=Y({__name:"TestDetail",props:{showDrawer:{type:Boolean,default:!1}},setup(A){const e=x("baseInfo");return(y,$)=>{const g=ge,T=be;return a(),h(T,{modelValue:e.value,"onUpdate:modelValue":$[0]||($[0]=S=>e.value=S),class:"enova-tabs h-full"},{default:t(()=>[l(g,{label:y.$t("common.title.baseInfo"),name:"baseInfo",lazy:!0},{default:t(()=>[l(at)]),_:1},8,["label"]),l(g,{label:y.$t("common.title.metrics"),name:"gpuInfo",class:"h-full",lazy:!0},{default:t(()=>[l(Ce)]),_:1},8,["label"])]),_:1},8,["modelValue"])}}}),nt={class:"flex h-full flex-col pb-5 px-4"},ot={class:"flex flex-col w-full h-full flex-1"},rt={class:"flex flex-row-reverse gap-4 items-center py-4"},it={class:"w-[440px]"},ut={class:"truncate"},ct=["onClick"],pt={key:1},_t={key:3},dt={key:4,class:"flex items-center gap-3"},mt={key:5,class:"flex items-center gap-2"},ft={key:6},vt={key:7},Ut=Y({__name:"TestRecord",setup(A){const{t:e}=Z(),y=G(),$=De(),{testList:g,currentId:T,drawerVisible:S}=W(y),{currentId:z,instanceList:B,instanceNameMap:M}=W($),N=x(!1),o=x(""),d=x("detail"),i=x([]),m=x(!1),u=x({current_page:1,page_count:10,total:0,pageSize:20}),C=D(()=>d.value==="detail"?e("instance.title.instanceDetail"):e("experiment.title.testResult")),w={running:{color:"#909399",text:e("experiment.title.testing")},success:{color:"#67C23A",text:e("experiment.title.testSuccess")},failed:{color:"#F56C6C",text:e("experiment.title.testFail")},unknown:{color:"#909399",text:e("experiment.title.testUnknown")},init:{color:"#909399",text:e("experiment.title.testInit")},finsihed:{color:"#909399",text:e("experiment.title.finished")}},L=D(()=>g.value.length===0?[]:[...new Set(g.value.map(s=>s.test_status))].map(s=>{var f;return{text:((f=w[s])==null?void 0:f.text)??s,value:s}})),n=(s,f)=>f.test_status===s,ee=x([{prop:"create_time",label:e("experiment.title.testTime"),sortable:!0,minWidth:"180px"},{prop:"test_id",label:e("experiment.title.testId"),width:"220px",showTip:!0},{prop:"instanceName",label:e("experiment.title.testInstance"),sortable:!0,width:"180px"},{prop:"dataset",label:e("experiment.title.testDataset"),sortable:!0,width:"180px"},{prop:"state",label:e("experiment.title.testStatus"),sortable:!0,filterData:L,filterMethod:n,width:"180px"},{prop:"generation_tps",label:e("experiment.title.generation"),sortable:!0,minWidth:"180px"},{prop:"avg_time",label:e("experiment.title.avgTime"),sortable:!0,minWidth:"180px"},{prop:"operation",label:e("common.title.operation"),fixed:"right",width:"150px"}]),F=(s,f)=>{f==="detail"?(z.value=s.instance_id,o.value=M.value.get(s.instance_id)??s.instance_id):(T.value=s.test_id,o.value=s.test_id),d.value=f,N.value=!0},{pause:O,resume:te}=Fe(()=>{V()},5e3),se=()=>{S.value=!1,N.value=!1,z.value="",T.value="",te()},ae=()=>{S.value=!0,Ve(),O()},le=s=>{i.value=s,V()},q=x(""),ne=s=>{q.value=s,V()},oe=()=>{if(g.value.length===0)return;g.value.some(f=>f.test_status!=="success")||O()},V=async()=>{m.value=!0;const{current_page:s,pageSize:f}=u.value;let R=`page=${s}&size=${f}`;i.value!=null&&i.value.length>0&&(R+=`&start_time=${i.value[0]}&end_time=${i.value[1]}`),q.value!==""&&(R+=`&fuzzy=${q.value}`);try{const k=await y.getTestList(R);oe(),k!=null&&(u.value={current_page:k.page,page_count:k.total_page,total:k.total_num,pageSize:k.size})}catch(k){console.log(k)}m.value=!1},re=s=>{const f=s!=null?Number(s):0;return f===0?0:(f/1e3).toFixed(3)};return Le(()=>{B.value.length===0&&$.getInstanceList(),V()}),(s,f)=>{const R=we,k=$e,ie=Me,ue=Te,ce=ye,pe=Re,_e=ke;return a(),v("main",nt,[l(Se,{title:s.$t("experiment.title.testRecord"),count:u.value.total},null,8,["title","count"]),r("div",ot,[r("div",rt,[l(Ie,{"search-tips":s.$t("experiment.inst.searchPlaceholder"),onChangeSearch:ne},null,8,["search-tips"]),r("div",it,[l(Ee,{onChangTimeRange:le})])]),Ue((a(),h(ce,{class:"enova-table test-record-table flex-1",data:P(g),style:{width:"100%"}},{default:t(()=>[(a(!0),v(I,null,E(ee.value,p=>(a(),h(ue,{key:p.prop,prop:p.prop,label:p.label,width:p.width,"min-width":p.minWidth,fixed:p.fixed,"column-key":p.prop,sortable:p.sortable,"sort-orders":["ascending","descending"],filters:p.filterData,"filter-method":p.filterMethod,"show-overflow-tooltip":p.showTip},{header:t(({column:_})=>[["avg_time","generation_tps"].includes(_.property)?(a(),h(R,{key:0,content:_.label},{default:t(()=>[r("span",ut,c(_.label),1)]),_:2},1032,["content"])):b("",!0)]),default:t(_=>{var j,H,J,K,Q;return[p.prop==="test_id"?(a(),v("span",{key:0,class:"cursor-pointer text-sm text-secondary font-medium",onClick:X=>F(_.row,"result")},c(_.row.test_id),9,ct)):b("",!0),p.prop==="create_time"?(a(),v("span",pt,c(P(qe)(_.row.create_time,"YYYY-MM-DD HH:mm:ss").value),1)):b("",!0),p.prop==="instanceName"?(a(),h(k,{key:2,link:"",type:"primary",size:"small",onClick:X=>F(_.row,"detail")},{default:t(()=>[U(c(P(M).get(_.row.instance_id)??_.row.instance_id),1)]),_:2},1032,["onClick"])):b("",!0),p.prop==="dataset"?(a(),v("span",_t,c((j=_.row.test_spec)==null?void 0:j.data_set),1)):b("",!0),p.prop==="state"?(a(),v("div",dt,[r("span",{class:"shrink-0 w-3 h-3 block border-2 rounded-full",style:Be({borderColor:(H=w[_.row.test_status])==null?void 0:H.color})},null,4),r("span",null,c((J=w[_.row.test_status])==null?void 0:J.text),1)])):b("",!0),p.prop==="creator"?(a(),v("div",mt,[l(ie,{name:"user",class:"shrink-0 text-[#c0c4cc]"}),r("span",null,c(_.row.creator),1)])):b("",!0),p.prop==="generation_tps"?(a(),v("span",ft,c(_.row.test_status==="success"?_.row.generation_tps:"-"),1)):b("",!0),p.prop==="avg_time"?(a(),v("span",vt,c(_.row.test_status==="success"?`${re((Q=(K=_.row)==null?void 0:K.result)==null?void 0:Q.elasped_avg)}s`:"-"),1)):b("",!0),p.prop==="operation"?(a(),v(I,{key:8},[l(k,{link:"",type:"primary",size:"small",onClick:X=>F(_.row,"result")},{default:t(()=>[U(c(s.$t("experiment.title.testResult")),1)]),_:2},1032,["onClick"]),b("",!0)],64)):b("",!0)]}),_:2},1032,["prop","label","width","min-width","fixed","column-key","sortable","filters","filter-method","show-overflow-tooltip"]))),128))]),_:1},8,["data"])),[[_e,m.value]]),l(Ne,{pagination:u.value,"onUpdate:pageChanged":V},null,8,["pagination"])]),l(pe,{showDrawer:N.value,title:C.value,"title-desc":o.value,size:"95%",onOpen:ae,onCloseDrawer:se},{default:t(()=>[d.value==="detail"?(a(),h(ze,{key:0})):(a(),h(lt,{key:1}))]),_:1},8,["showDrawer","title","title-desc"])])}}});export{Ut as default};
